<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Karavan Asistent (Full)</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 800px; margin: 10px auto; padding: 15px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #007bff; font-size: 1.2em; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
        label { font-weight: bold; font-size: 0.85em; display: block; margin-top: 15px; color: #555; }
        input, select { width: 100%; margin: 5px 0 10px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: white; }
        .row { display: flex; gap: 10px; }
        button { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; -webkit-appearance: none; }
        .btn-add { background: #28a745; color: white; width: 100%; margin-top: 20px; font-size: 1.1em; }
        .btn-load { background: #007bff; color: white; margin-bottom: 15px; width: 100%; }
        .btn-delete { background: #dc3545; color: white; padding: 8px 15px; font-size: 0.85em; width: auto; margin-left: 5px; }
        .btn-edit { background: #ffc107; color: black; padding: 8px 15px; font-size: 0.85em; width: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .token-area { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        #status { padding: 15px; margin-top: 10px; border-radius: 8px; display: none; text-align: center; font-weight: bold; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; min-width: 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .lang-group { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 5px; border: 1px dashed #ddd; }
        .category-badge { background: #007bff; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; text-transform: uppercase; margin-bottom: 5px; display: inline-block; }
    </style>
</head>
<body>

<div id="status"></div>

<div class="token-area">
    <strong>üîë GitHub Token:</strong>
    <input type="password" id="ghToken" placeholder="Vlo≈æte ghp_..." autocomplete="off">
</div>

<div class="card">
    <h2 id="formTitle">‚ûï Prida≈• nov√Ω z√°znam</h2>
    <form id="addForm">
        <input type="hidden" id="editData" value="">
        <label>Kam prida≈• z√°znam?</label>
        <select id="targetSelect" required>
            <option value="0,0">üõ† Servis a doplnky</option>
            <option value="0,1">üöê Po≈æiƒçovne Karavanov</option>
            <option value="1,0">üîç Vyhƒæad√°vanie kempov (Odkazy)</option>
            <option value="1,1">üÜò Pomoc v n√∫dzi (Odkazy)</option>
            <option value="2,0" selected>üèï Partnersk√© kempy</option>
        </select>

        <label>N√°zov (SK / EN / DE / CS / HU):</label>
        <div class="lang-group">
            <input type="text" id="name_sk" placeholder="Slovensk√Ω n√°zov" required>
            <input type="text" id="name_en" placeholder="English (voliteƒæn√©)">
            <input type="text" id="name_de" placeholder="Deutsch (voliteƒæn√©)">
            <input type="text" id="name_cs" placeholder="ƒåe≈°tina (voliteƒæn√©)">
            <input type="text" id="name_hu" placeholder="Magyar (voliteƒæn√©)">
        </div>

        <div class="row">
            <div style="flex:1">
                <label>Krajina (SK, AT, ALL...):</label>
                <input type="text" id="country" placeholder="SK" required>
            </div>
            <div style="flex:1">
                <label>Je to Partner?</label>
                <select id="isPartner">
                    <option value="true">√Åno</option>
                    <option value="false">Nie</option>
                </select>
            </div>
        </div>

        <label>URL / Web:</label>
        <input type="url" id="url" placeholder="https://..." required>

        <label>Benefit (len ak je partner):</label>
        <div class="lang-group">
            <input type="text" id="benefit_sk" placeholder="Benefit SK">
            <input type="text" id="benefit_en" placeholder="Benefit EN">
            <input type="text" id="benefit_de" placeholder="Benefit DE">
            <input type="text" id="benefit_cs" placeholder="Benefit CS">
            <input type="text" id="benefit_hu" placeholder="Benefit HU">
        </div>

        <label>Telef√≥n:</label>
        <input type="text" id="phone" placeholder="+421...">

        <button type="submit" id="btnSubmit" class="btn-add">üöÄ Odosla≈• na GitHub</button>
        <button type="button" id="btnCancelEdit" class="btn-load" style="display:none; margin-top:10px; background:#6c757d;" onclick="cancelEdit()">Zru≈°i≈• √∫pravu</button>
    </form>
</div>

<div class="card">
    <h2>üìã Aktu√°lny obsah JSONu</h2>
    <button class="btn-load" onclick="loadItems()">üîÑ Naƒç√≠ta≈• v≈°etko</button>
    <div id="itemList"></div>
</div>

<script>
    const GITHUB_USERNAME = 'appkynacesty';
    const GITHUB_REPO = 'KaravanAsistent';
    const GITHUB_FILE_PATH = 'app_emergency.json';

    const getUrl = () => `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}?cb=${Date.now()}`;

    function getToken() { return document.getElementById('ghToken').value.trim() || null; }

    async function getGitHubData() {
        const token = getToken();
        if (!token) { alert("Ch√Ωba token!"); return null; }
        try {
            const res = await fetch(getUrl(), {
                headers: { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json' }
            });
            if (!res.ok) throw new Error("Chyba " + res.status);
            const data = await res.json();
            const content = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
            return { content, sha: data.sha };
        } catch (e) { alert("Chyba pripojenia!"); return null; }
    }

    async function saveToGitHub(newContent, sha, message) {
        const token = getToken();
        const encoded = window.btoa(unescape(encodeURIComponent(JSON.stringify(newContent, null, 2))));
        const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`, {
            method: 'PUT',
            headers: { 'Authorization': 'token ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, content: encoded, sha })
        });
        return res.ok;
    }

    async function loadItems() {
        const listDiv = document.getElementById('itemList');
        listDiv.innerHTML = "‚åõ Naƒç√≠tavam...";
        const data = await getGitHubData();
        if (!data) { listDiv.innerHTML = ""; return; }

        listDiv.innerHTML = "";
        data.content.modules.forEach((mod, modIdx) => {
            mod.sections.forEach((sec, secIdx) => {
                const header = document.createElement('div');
                header.style.background = "#eee";
                header.style.padding = "5px 10px";
                header.style.fontWeight = "bold";
                header.style.fontSize = "0.8em";
                header.style.marginTop = "10px";
                header.textContent = `${mod.title.sk} > ${sec.heading.sk}`;
                listDiv.appendChild(header);

                sec.items.forEach((item, itemIdx) => {
                    const row = document.createElement('div');
                    row.className = 'item-row';
                    row.innerHTML = `
                        <div style="font-size: 0.9em; flex: 1;">
                            <strong>${item.name.sk}</strong><br>
                            <small>${item.url}</small>
                        </div>
                        <div>
                            <button class="btn-edit" onclick="editItem(${modIdx}, ${secIdx}, ${itemIdx})">Upravi≈•</button>
                            <button class="btn-delete" onclick="deleteItem(${modIdx}, ${secIdx}, ${itemIdx})">Zmaza≈•</button>
                        </div>
                    `;
                    listDiv.appendChild(row);
                });
            });
        });
        showStatus("‚úÖ D√°ta naƒç√≠tan√©", "#d4edda", "#155724");
    }

    async function editItem(mIdx, sIdx, iIdx) {
        const data = await getGitHubData();
        if (!data) return;
        const item = data.content.modules[mIdx].sections[sIdx].items[iIdx];

        document.getElementById('editData').value = `${mIdx},${sIdx},${iIdx}`;
        document.getElementById('targetSelect').value = `${mIdx},${sIdx}`;
        
        document.getElementById('name_sk').value = item.name.sk;
        document.getElementById('name_en').value = item.name.en || "";
        document.getElementById('name_de').value = item.name.de || "";
        document.getElementById('name_cs').value = item.name.cs || "";
        document.getElementById('name_hu').value = item.name.hu || "";
        
        document.getElementById('country').value = item.country;
        document.getElementById('isPartner').value = item.isPartner.toString();
        document.getElementById('url').value = item.url;
        document.getElementById('phone').value = item.phone || "";

        if (item.benefit) {
            document.getElementById('benefit_sk').value = item.benefit.sk || "";
            document.getElementById('benefit_en').value = item.benefit.en || "";
            document.getElementById('benefit_de').value = item.benefit.de || "";
            document.getElementById('benefit_cs').value = item.benefit.cs || "";
            document.getElementById('benefit_hu').value = item.benefit.hu || "";
        } else {
            document.getElementById('benefit_sk').value = "";
            document.getElementById('benefit_en').value = "";
            document.getElementById('benefit_de').value = "";
            document.getElementById('benefit_cs').value = "";
            document.getElementById('benefit_hu').value = "";
        }

        document.getElementById('formTitle').innerText = "‚úèÔ∏è Upravi≈• z√°znam";
        document.getElementById('btnSubmit').innerText = "üíæ Ulo≈æi≈• zmeny";
        document.getElementById('btnCancelEdit').style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        document.getElementById('addForm').reset();
        document.getElementById('editData').value = "";
        document.getElementById('formTitle').innerText = "‚ûï Prida≈• nov√Ω z√°znam";
        document.getElementById('btnSubmit').innerText = "üöÄ Odosla≈• na GitHub";
        document.getElementById('btnCancelEdit').style.display = "none";
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const editVal = document.getElementById('editData').value;
        const target = document.getElementById('targetSelect').value.split(',');
        const mIdx = parseInt(target[0]);
        const sIdx = parseInt(target[1]);

        showStatus("üöÄ Zapisujem...", "#007bff", "white");
        const data = await getGitHubData();
        if (!data) return;

        const name_sk = document.getElementById('name_sk').value;
        const b_sk = document.getElementById('benefit_sk').value;

        const newItem = {
            "name": { 
                "sk": name_sk, 
                "en": document.getElementById('name_en').value || name_sk, 
                "de": document.getElementById('name_de').value || name_sk,
                "cs": document.getElementById('name_cs').value || name_sk,
                "hu": document.getElementById('name_hu').value || name_sk
            },
            "isPartner": document.getElementById('isPartner').value === "true",
            "country": document.getElementById('country').value.toUpperCase(),
            "url": document.getElementById('url').value,
            "phone": document.getElementById('phone').value || ""
        };

        if (b_sk) {
            newItem.benefit = { 
                "sk": b_sk, 
                "en": document.getElementById('benefit_en').value || b_sk, 
                "de": document.getElementById('benefit_de').value || b_sk,
                "cs": document.getElementById('benefit_cs').value || b_sk,
                "hu": document.getElementById('benefit_hu').value || b_sk
            };
        }

        if (editVal) {
            const parts = editVal.split(',');
            const oldM = parseInt(parts[0]);
            const oldS = parseInt(parts[1]);
            const oldI = parseInt(parts[2]);
            // Zma≈æeme star√Ω a vlo≈æ√≠me nov√Ω (ak sa zmenil modul/sekcia, zma≈æe sa zo star√©ho miesta)
            data.content.modules[oldM].sections[oldS].items.splice(oldI, 1);
            data.content.modules[mIdx].sections[sIdx].items.push(newItem);
        } else {
            data.content.modules[mIdx].sections[sIdx].items.push(newItem);
        }

        data.content.lastUpdated = new Date().toISOString().split('T')[0];

        if (await saveToGitHub(data.content, data.sha, `Zmena: ${name_sk}`)) {
            showStatus("‚úÖ Ulo≈æen√©!", "#28a745", "white");
            cancelEdit();
            loadItems();
        }
    });

    async function deleteItem(mIdx, sIdx, iIdx) {
        if (!confirm("Zmaza≈• tento z√°znam?")) return;
        const data = await getGitHubData();
        if (!data) return;

        data.content.modules[mIdx].sections[sIdx].items.splice(iIdx, 1);
        data.content.lastUpdated = new Date().toISOString().split('T')[0];

        if (await saveToGitHub(data.content, data.sha, "Zmazanie z√°znamu")) {
            showStatus("‚úÖ Zmazan√©", "#28a745", "white");
            loadItems();
        }
    }

    function showStatus(text, bg, color) {
        const s = document.getElementById('status');
        s.style.display = "block"; s.textContent = text; s.style.backgroundColor = bg; s.style.color = color;
        setTimeout(() => s.style.display = "none", 3000);
    }
</script>
</body>
</html>
