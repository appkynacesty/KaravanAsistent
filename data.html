<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin - Karavan Asistent</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 800px; margin: 10px auto; padding: 15px; background: #f0f2f5; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #007bff; font-size: 1.3em; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
        label { font-weight: bold; font-size: 0.85em; display: block; margin-top: 15px; color: #555; }
        input { width: 100%; margin: 5px 0 10px; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .row { display: flex; gap: 10px; }
        button { padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; -webkit-appearance: none; }
        .btn-add { background: #28a745; color: white; width: 100%; margin-top: 20px; font-size: 1.1em; }
        .btn-load { background: #007bff; color: white; margin-bottom: 15px; width: 100%; }
        .btn-delete { background: #dc3545; color: white; padding: 8px 15px; font-size: 0.85em; width: auto; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .token-area { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        #status { padding: 15px; margin-top: 10px; border-radius: 8px; display: none; text-align: center; font-weight: bold; }
        .lang-group { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 5px; border: 1px dashed #ddd; }
        small { color: #666; line-height: 1.4; display: block; margin-top: 5px; }
    </style>
</head>
<body>

<div id="status"></div>

<div class="token-area">
    <strong>üîë GitHub Token (ghp_...):</strong>
    <input type="password" id="ghToken" placeholder="Vlo≈æte token sem" autocomplete="off">
    <small>Tip: Ak to nefunguje, sk√∫s Anonymn√Ω re≈æim (Incognito) kv√¥li vypnutiu ≈°etriƒça d√°t.</small>
</div>

<div class="card">
    <h2>‚ûï Prida≈• partnersk√Ω kemp</h2>
    <form id="addForm">
        <label>N√°zov kempu:</label>
        <div class="lang-group">
            <input type="text" id="name_sk" placeholder="Slovensk√Ω n√°zov" required>
            <input type="text" id="name_en" placeholder="English (voliteƒæn√©)">
            <input type="text" id="name_de" placeholder="Deutsch (voliteƒæn√©)">
        </div>

        <div class="row">
            <div style="flex:1">
                <label>Krajina:</label>
                <input type="text" id="country" placeholder="SK" required>
            </div>
            <div style="flex:2">
                <label>URL webu:</label>
                <input type="url" id="url" placeholder="https://..." required>
            </div>
        </div>

        <label>Benefit:</label>
        <div class="lang-group">
            <input type="text" id="benefit_sk" placeholder="Benefit SK">
            <input type="text" id="benefit_en" placeholder="Benefit EN">
            <input type="text" id="benefit_de" placeholder="Benefit DE">
        </div>

        <label>Telef√≥n:</label>
        <input type="text" id="phone" placeholder="+421...">

        <button type="submit" class="btn-add">üöÄ Odosla≈• na GitHub</button>
    </form>
</div>

<div class="card">
    <h2>üìã Zoznam kempov</h2>
    <button class="btn-load" onclick="loadItems()">üîÑ Naƒç√≠ta≈• zoznam</button>
    <div id="itemList"></div>
</div>

<script>
    // --- KONFIGUR√ÅCIA ---
    const GITHUB_USERNAME = 'appkynacesty';
    const GITHUB_REPO = 'KaravanAsistent';
    const GITHUB_FILE_PATH = 'app_emergency.json';
    const PARTNER_MODULE_INDEX = 2;
    const PARTNER_SECTION_INDEX = 0;

    // Adresa s cache-busterom
    const getUrl = () => `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}?cb=${Date.now()}`;

    function getToken() {
        const t = document.getElementById('ghToken').value.trim();
        return t || null;
    }

    async function getGitHubData() {
        const token = getToken();
        if (!token) { alert("Ch√Ωba token!"); return null; }

        try {
            const res = await fetch(getUrl(), {
                method: 'GET',
                headers: {
                    'Authorization': 'token ' + token,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!res.ok) {
                const err = await res.json();
                alert(`Chyba ${res.status}: ${err.message}`);
                return null;
            }

            const data = await res.json();
            const content = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
            return { content, sha: data.sha };
        } catch (e) {
            alert("üö® Failed to fetch!\n\nSk√∫s:\n1. Anonymn√© okno\n2. Vypn√∫≈• ≈°etriƒç d√°t\n3. In√Ω prehliadaƒç");
            return null;
        }
    }

    async function saveToGitHub(newContent, sha, message) {
        const token = getToken();
        const encoded = window.btoa(unescape(encodeURIComponent(JSON.stringify(newContent, null, 2))));
        
        try {
            const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${GITHUB_FILE_PATH}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'token ' + token,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message, content: encoded, sha })
            });
            if (!res.ok) {
                const err = await res.json();
                alert("Chyba ukladania: " + err.message);
            }
            return res.ok;
        } catch (e) {
            alert("Ukladanie zlyhalo (Fetch error).");
            return false;
        }
    }

    async function loadItems() {
        const listDiv = document.getElementById('itemList');
        listDiv.innerHTML = "‚åõ Naƒç√≠tavam...";
        const data = await getGitHubData();
        if (!data) { listDiv.innerHTML = ""; return; }

        const items = data.content.modules[PARTNER_MODULE_INDEX].sections[PARTNER_SECTION_INDEX].items;
        listDiv.innerHTML = "";
        
        items.forEach((item, index) => {
            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `<div><strong>${item.name.sk}</strong></div><button class="btn-delete" onclick="deleteItem(${index})">Zmaza≈•</button>`;
            listDiv.appendChild(row);
        });
        showStatus("‚úÖ D√°ta naƒç√≠tan√©", "#d4edda", "#155724");
    }

    document.getElementById('addForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        showStatus("üöÄ Zapisujem...", "#007bff", "white");
        const data = await getGitHubData();
        if (!data) return;

        const name_sk = document.getElementById('name_sk').value;
        const b_sk = document.getElementById('benefit_sk').value;

        const newItem = {
            "name": { "sk": name_sk, "en": document.getElementById('name_en').value || name_sk, "de": document.getElementById('name_de').value || name_sk },
            "isPartner": true,
            "country": document.getElementById('country').value.toUpperCase(),
            "url": document.getElementById('url').value,
            "phone": document.getElementById('phone').value || ""
        };

        if (b_sk) {
            newItem.benefit = { "sk": b_sk, "en": document.getElementById('benefit_en').value || b_sk, "de": document.getElementById('benefit_de').value || b_sk };
        }

        data.content.modules[PARTNER_MODULE_INDEX].sections[PARTNER_SECTION_INDEX].items.push(newItem);
        data.content.lastUpdated = new Date().toISOString().split('T')[0];

        if (await saveToGitHub(data.content, data.sha, "Pridanie kempu")) {
            showStatus("‚úÖ Ulo≈æen√©!", "#28a745", "white");
            document.getElementById('addForm').reset();
            loadItems();
        }
    });

    async function deleteItem(index) {
        if (!confirm("Zmaza≈•?")) return;
        const data = await getGitHubData();
        if (!data) return;
        data.content.modules[PARTNER_MODULE_INDEX].sections[PARTNER_SECTION_INDEX].items.splice(index, 1);
        if (await saveToGitHub(data.content, data.sha, "Zmazanie kempu")) {
            showStatus("‚úÖ Zmazan√©", "#28a745", "white");
            loadItems();
        }
    }

    function showStatus(text, bg, color) {
        const s = document.getElementById('status');
        s.style.display = "block"; s.textContent = text; s.style.backgroundColor = bg; s.style.color = color;
        setTimeout(() => s.style.display = "none", 3000);
    }
</script>
</body>
</html>
